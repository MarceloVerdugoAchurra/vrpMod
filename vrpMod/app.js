//url: http://xxxxxxxxxxxxxxxxxxxx:3000/solver?param1=-33.440722,-70.677397|-33.440164,-70.657804|-33.444993,-70.581136&param2=434
//url2 de prueba : http://xxxxxxxxxxxxxxxx/solver?param1=-33.4323,-70.7556|-33.4469,-70.7182|-33.4767,-70.7264|-33.4667,-70.7491|-33.4701,-70.6292|-33.4420,-70.6200|-33.4819,-70.6052|-33.5288,-70.6265|-33.5176,-70.6835|-33.5091,-70.7041|-33.4990,-70.7219|-33.4907,-70.7326|-33.4773,-70.6986|-33.4710,-70.6756|-33.4526,-70.6739|-33.4469,-70.6505|-33.4217,-70.6594|-33.4014,-70.6516|-33.3821,-70.6787|-33.3770,-70.6670|-33.3529,-70.7230|-33.3099,-70.7206|-33.3982,-70.5829|-33.3862,-70.5571|-33.3836,-70.5383&param2=[["0,0","5503,914","8310,1237","9056,1140","23627,1713","24863,1751","34376,2162","25104,1734","20668,1514","17840,1355","17322,1484","13051,1210","11921,1498","18840,1350","10779,1492","20407,1505","18233,1254","22227,1606","18628,1203","18336,1235","14300,1458","22876,1401","26306,1562","30829,1759","32433,1641"],["5073,936","0,0","5500,930","6809,1102","11786,1676","10417,1781","15672,2009","21748,1629","12710,1446","11388,933","7873,1277","7575,1192","7615,847","8708,944","5262,917","8269,1455","7690,1201","12737,1694","11206,1401","15085,1414","19060,1680","19414,1523","18350,1614","22873,1811","24477,1693"],["8261,1336","5769,991","0,0","3968,788","11022,1556","11462,1828","13280,1946","18576,1485","9444,1252","8114,868","3104,536","2805,452","6123,856","6345,772","6638,973","9023,1467","13752,1456","16210,1879","14680,1585","18558,1598","22206,1910","22887,1707","21825,1765","26348,1961","27952,1843"],["10060,990","6734,990","3677,528","0,0","17244,1613","13360,1982","28381,1819","19109,1391","14672,1171","11845,1012","6102,917","5481,771","9545,1096","12844,1007","8205,1126","11212,1656","22095,1409","26089,1762","22490,1359","22197,1390","18162,1614","26738,1557","30168,1718","34691,1915","36295,1796"],["19683,1831","17718,1735","15009,1559","16052,1814","0,0","4317,868","4136,684","8071,1147","9590,1127","10904,1322","11523,1625","15463,1610","7861,1328","6062,1040","6538,1056","4442,798","8500,1127","9380,1713","14368,1400","19209,1626","23183,1891","23537,1734","11728,1512","16251,1709","17855,1590"],["17751,1686","15786,1591","18107,1872","26151,1961","5382,986","0,0","6063,1067","17155,1834","17295,1476","20586,1447","21102,1774","21198,1765","16812,1361","9269,1539","6585,1223","3587,692","6578,1001","7758,1453","12442,1268","13612,1494","21257,1759","21611,1602","8371,1026","12894,1223","14498,1104"],["35418,2145","15886,1945","17117,1677","27865,1854","4446,629","5893,951","0,0","7689,1158","11698,1244","20298,1437","22412,1531","24394,1599","9969,1446","8169,1157","9248,1246","8034,1216","11728,1460","11985,2102","17597,1733","22437,1959","26412,2224","26766,2067","12114,1859","18223,1944","19826,1825"],["26458,1665","21798,1649","17317,1346","18906,1374","7496,964","11724,1679","7951,1113","0,0","5828,918","11338,957","13452,1051","15435,1119","16120,1214","15678,1031","18948,1398","10651,1515","16040,1437","22614,2056","21909,1711","30894,1819","34869,2084","35223,1927","18954,1961","29724,2082","31328,1963"],["21482,1338","16822,1323","12341,1019","13930,1047","9869,1040","13056,1372","18527,1309","9255,881","0,0","6363,630","8476,724","10459,793","11144,887","10703,704","10809,1049","10617,1011","12747,936","19320,1555","18615,1210","23456,1435","27431,1701","27785,1544","21907,1384","26430,1581","28034,1463"],["17340,1298","12706,1171","7130,1005","9788,1007","11695,1342","18886,1628","21405,1425","12133,996","4516,743","0,0","4324,617","5733,690","7028,736","6587,553","9857,920","16447,1267","16996,1198","19454,1621","17924,1327","21802,1340","25777,1606","26131,1449","25069,1507","29592,1703","31196,1585"],["15608,1147","8244,1324","3100,542","8056,856","11001,1511","20466,1859","22985,1657","13713,1228","7599,1063","8081,822","0,0","2249,386","6076,910","6325,727","8885,1116","18027,1498","20157,1424","31637,1919","28038,1517","27746,1548","23710,1771","26188,1725","25127,1782","29650,1979","31253,1861"],["13573,1079","8354,1236","2937,445","6021,788","14661,1396","18166,1912","24616,1634","15343,1205","10907,985","8337,817","2244,387","0,0","9570,894","6569,722","12398,1117","15727,1551","21787,1401","29602,1851","26003,1448","25710,1479","21675,1703","30251,1646","33681,1807","38204,2004","39808,1885"],["18282,1371","7919,1151","6787,902","10561,1153","7215,1120","10185,1647","10545,1573","16621,1231","7582,1009","6261,535","5840,755","5936,746","0,0","2538,336","5099,726","7746,1286","12475,1241","14933,1663","13402,1370","17281,1383","21256,1648","21610,1492","20548,1549","25071,1746","26675,1628"],["19987,1385","8208,1132","7633,908","12265,1166","4671,783","7843,1319","7958,1201","10042,1384","8750,850","7086,608","6686,761","6783,751","2740,389","0,0","2555,389","5404,958","7535,936","14108,1555","13403,1210","19056,1283","23031,1548","23385,1392","16695,1384","21218,1581","22822,1463"],["13428,1412","5407,922","6357,1007","8393,1254","6837,1101","6027,1101","9674,1550","18730,1529","11531,1063","8370,832","8392,946","8489,937","4447,574","2706,359","0,0","3879,775","4898,935","11472,1495","10767,1150","15496,1205","19471,1471","19825,1314","14059,1324","18582,1521","20186,1402"],["15467,1424","7651,1260","8908,1395","10637,1591","5072,861","3945,741","9254,1427","13032,1341","10358,828","11583,1190","17157,1208","19139,1277","6995,1054","5255,839","2319,541","0,0","4283,779","6345,1272","10152,994","14992,1219","18967,1485","19321,1328","10362,1178","14885,1374","16489,1256"],["14078,1261","12113,1165","14434,1447","22478,1535","8772,1077","9898,1127","12293,1484","15526,1459","12851,946","16913,1021","17429,1349","17526,1339","13140,935","8739,952","4796,786","5552,869","0,0","4562,843","8126,773","12967,998","16942,1264","17296,1107","11342,939","15865,1136","17469,1017"],["23495,1772","15756,1721","18077,2002","26574,1962","9800,1709","8038,1481","13333,2242","19940,2118","17265,1605","20556,1577","21072,1904","21169,1894","16783,1491","13153,1612","9210,1445","6178,1294","4253,813","0,0","4430,808","4084,795","12787,1490","15580,1334","8480,1260","11742,1397","13345,1279"],["19106,1395","16218,1456","26175,1675","22186,1586","14544,1339","14097,1389","18064,1746","21297,1721","18623,1208","21018,1312","21534,1639","26181,1656","17245,1226","14511,1215","10567,1048","11324,1131","5786,939","4405,769","0,0","1734,380","8399,1113","12291,889","12242,1076","15504,1213","17108,1095"],["19567,1464","16687,1518","26636,1743","22647,1654","16497,1733","12816,1358","16724,2054","23251,2115","20576,1602","21486,1373","22003,1701","26642,1725","17713,1288","18806,1385","12521,1442","15016,1425","7110,1256","4217,802","1809,406","0,0","8860,1182","11652,1026","10961,1044","14223,1182","15826,1063"],["15382,1556","19621,1600","22451,1835","18462,1746","19642,1755","20908,1819","23163,2163","26396,2137","23722,1624","24420,1456","24937,1783","22456,1817","20647,1370","21740,1468","15666,1464","16422,1547","12034,1358","13392,1430","7382,974","9500,1058","0,0","7700,843","18940,1538","22202,1675","23806,1557"],["27408,1724","24296,1662","26617,1944","30487,1915","27525,1874","28791,1938","31046,2281","39456,2215","31605,1743","29095,1518","29612,1846","29708,1836","25322,1432","26415,1530","23549,1583","24305,1666","19917,1477","19717,1516","16119,1114","15826,1145","12877,1018","0,0","27174,1582","30424,1717","32028,1598"],["22180,1555","20215,1459","22536,1740","30580,1829","13146,1507","8129,1066","12524,1772","19406,1951","21725,1344","25015,1315","25531,1642","25628,1633","21242,1229","17613,1350","13669,1183","10296,1104","11007,869","8720,1231","12378,1125","11041,1045","18302,1501","21094,1345","0,0","3281,583","4753,814"],["25667,1617","23703,1521","26023,1803","34067,1891","16633,1569","11617,1128","15520,1843","27886,1919","25212,1406","28502,1377","29018,1704","29115,1695","24729,1291","21100,1412","17156,1246","13783,1166","14495,931","13761,1343","20358,1198","16082,1158","23343,1614","26136,1458","3387,592","0,0","2254,374"],["26425,1607","24460,1512","26781,1793","34825,1882","17390,1560","12374,1119","16277,1834","28643,1910","25969,1397","29260,1368","29776,1695","29873,1686","25487,1282","21857,1403","17914,1236","14541,1157","15252,922","14519,1334","21116,1189","16840,1148","24101,1604","26893,1449","5954,536","2181,343","0,0"]]
var fs = require('fs');

const util = require('util');

var vrpMod = require('./vrpMod.js');

var express = require("express"),
    app = express(),
    bodyParser = require("body-parser"),
    methodOverride = require("method-override");
mongoose = require('mongoose');

app.use(bodyParser.urlencoded({
    extended: false
}));
app.use(bodyParser.json());
app.use(methodOverride());

var router = express.Router();

global.fileName = "";
global.pathFile = "";


function getFecha() {
    var today = new Date();
    var day = today.getDate() + "";
    var month = (today.getMonth() + 1) + "";
    var year = today.getFullYear() + "";
    var hour = today.getHours() + "";
    var minutes = today.getMinutes() + "";
    var seconds = today.getSeconds() + "";

    day = checkZero(day);
    month = checkZero(month);
    year = checkZero(year);
    hour = checkZero(hour);
    mintues = checkZero(minutes);
    seconds = checkZero(seconds);

    return day + "_" + month + "_" + year + "_" + hour + "_" + minutes + "_" + seconds;

}

function checkZero(data) {
    if (data.length == 1) {
        data = "0" + data;
    }
    return data;
}

//***************************************************************************
function parsearLocations(cadena) {

    var arrFinal = [];
    var arr1 = [];
    arr1 = cadena.split("|");

    var i = 0;

    for (i = 0; i < arr1.length; i++) {

        var arrTemp = [];

        arrTemp = (arr1[i].split(","));

        var value1 = parseFloat(arrTemp[0]);
        var value2 = parseFloat(arrTemp[1]);

        arrFinal.push([value1, value2]);
    }

    return arrFinal;

}
//***************************************************************************


router.get('/solver', function(req, res) {

    //***************************************************************************   

    //***************************************************************************   

    fileName = "file" + getFecha() + ".txt";
	pathFile = process.cwd();

    var locations = parsearLocations(req.query.param1);

    //var param1 = req.query.param1;
    var distancia_tiempo = req.query.param2;

    //for(var i = 0; i < locations.length; i++){
    //  console.log(locations[i]);
    //}


    //********** PARSEO DEL PARAM2 **********

    //convierte un string con formato de cadena en objeto JSON.
    var matriz_distancia = JSON.parse(distancia_tiempo);
    var matriz_tiempo = JSON.parse(distancia_tiempo);

    for (i = 0; i < matriz_distancia.length; i++) {
        for (j = 0; j < matriz_distancia.length; j++) {
            var array_aux = matriz_distancia[i][j].split(",");
            matriz_distancia[i][j] = parseFloat(array_aux[0]);
        }
    }

    for (i = 0; i < matriz_tiempo.length; i++) {
        for (j = 0; j < matriz_tiempo.length; j++) {

            var array_aux = matriz_tiempo[i][j].split(",");
            matriz_tiempo[i][j] = parseFloat(array_aux[1]);

        }
    }


    ///********** PARSEO DEL PARAM2 **********


    vrpMod.solver(locations, matriz_tiempo, matriz_distancia, function(err, resSolver) {
        if (err) console.error(err);
        console.log('RES' + resSolver);

        console.log("*********************...." + resSolver);




        var fs = require('fs');

        // Change the content of the file as you want
        // or either set fileContent to null to create an empty file
        var fileContent = util.inspect(resSolver, {
            showHidden: false,
            depth: null
        });

        // The absolute path of the new file with its name
        var filepath = fileName;

        fs.writeFile(filepath, fileContent, (err) => {
            if (err) throw err;

            console.log("The file was succesfully saved!");
        });


        fs.readFile(pathFile+ '/' + fileName, 'utf8', function(err, contents) {			
            console.log(contents);

            //coloca comillas (quotes)
            contents = contents.replace('cost', '"cost"');
            contents = contents.replace('routes', '"routes"');
            contents = contents.replace('times', '"times"');


            // set response header
            res.setHeader('content-type', 'application/json');
            var headerStr = JSON.parse(JSON.stringify(contents));
            res.write(headerStr);
            res.end();

			fs.unlinkSync(pathFile+ '/' + fileName); 

        });


    });




});

app.use(router);

app.listen(4000, function() {
    console.log("Node server running on http://localhost:4000");
});
